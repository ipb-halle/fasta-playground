<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:h="http://xmlns.jcp.org/jsf/html"
	xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
	xmlns:f="http://xmlns.jcp.org/jsf/core"
	xmlns:c="http://xmlns.jcp.org/jsp/jstl/core"
	xmlns:fn="http://xmlns.jcp.org/jsp/jstl/functions"
	xmlns:of="http://omnifaces.org/functions"
	xmlns:b="http://bootsfaces.net/ui">
<h:head>
	<title>Library search with FASTA</title>
	<h:outputStylesheet name="css/styles.css" />
</h:head>
<h:body>
	<b:container>
		<h1>Sequence library search with the FASTA program</h1>
		<h2>Input</h2>
		<b:form>
			<b:panelGrid col-spans="9,3">
				<h:panelGroup id="libraryId">
					<b:inputTextarea value="#{fastaLibrarySearchBean.library}"
						required="true" label="Sequence library (DNA or AA)"
						placeholder="Paste or drag and drop library sequences in FASTA format here ..."
						styleClass="libraryTextAreaPseudoClass" />
					<b:message for="@previous" />
				</h:panelGroup>
				<h:panelGroup>
					<br />
					<b:commandButton value="Protein example" ajax="true"
						process="@this" update="libraryId queryId searchModeId"
						action="#{fastaLibrarySearchBean.actionProteinExample()}">
						<!-- This solves https://stackoverflow.com/q/21179403 -->
						<f:actionListener
							type="org.omnifaces.eventlistener.ResetInputAjaxActionListener" />
					</b:commandButton>
					<br />
					<b:commandButton value="DNA example" ajax="true" process="@this"
						update="libraryId queryId searchModeId"
						action="#{fastaLibrarySearchBean.actionDNAExample()}">
						<f:actionListener
							type="org.omnifaces.eventlistener.ResetInputAjaxActionListener" />
					</b:commandButton>
					<br />
					<!--<b:commandButton value="RNA example" ajax="true" process="@this"
						update="libraryId queryId searchModeId"
						action="#{fastaLibrarySearchBean.actionRNAExample()}">
						<f:actionListener
							type="org.omnifaces.eventlistener.ResetInputAjaxActionListener" />
					</b:commandButton>-->
				</h:panelGroup>
				<h:panelGroup id="queryId">
					<b:inputTextarea value="#{fastaLibrarySearchBean.query}"
						required="true" label="Query sequence"
						placeholder="Paste or drag and drop a query sequence in FASTA format here ..."
						styleClass="queryTextAreaPseudoClass" />
					<b:message for="@previous" />
				</h:panelGroup>
				<h:panelGroup>
					<b:selectOneMenu id="searchModeId"
						value="#{fastaLibrarySearchBean.searchMode}" required="true"
						label="Search mode">
						<f:selectItems value="#{fastaLibrarySearchBean.searchModeItems}"
							var="item" itemValue="#{item}" itemLabel="#{item.label}" />
					</b:selectOneMenu>
					<br />
					<b:selectOneMenu value="#{fastaLibrarySearchBean.maxResults}"
						required="true" label="Maximum number of results">
						<f:selectItems
							value="#{fastaLibrarySearchBean.maxResultSelectItems}" />
					</b:selectOneMenu>
					<b:message for="@previous" />
					<br />
					<b:button value="Clear" look="warning" style="margin-right:10px;"
						onclick="$('.libraryTextAreaPseudoClass')[0].value='';$('.queryTextAreaPseudoClass')[0].value='';" />
					<b:commandButton value="Search"
						action="#{fastaLibrarySearchBean.actionSearch()}" ajax="true"
						process="@form" update="@form resultsId fastaOutputId"
						look="primary" />
				</h:panelGroup>
			</b:panelGrid>
			<hr />
			<h2>Results</h2>
			<h:panelGroup id="resultsId">
				<b:panelGrid col-spans="3,2,2,5"
					rendered="#{fn:length(fastaLibrarySearchBean.results) gt 0}">
					<b:selectOneMenu value="#{fastaLibrarySearchBean.sortBy}"
						required="true" label="Sort by" ajax="true"
						onchange="ajax:fastaLibrarySearchBean.actionOnChangeSortBy()"
						process="@this" update="resultsId">
						<f:selectItems value="#{fastaLibrarySearchBean.sortByItems}"
							var="item" itemValue="#{item}" itemLabel="#{item.label}" />
					</b:selectOneMenu>
					<b:button value="Collapse all results"
						onclick="$('.fastaResultPanel > .panel-heading > .panel-title-link:not(.collapsed)').click();" />
					<b:button value="Expand all results"
						onclick="$('.fastaResultPanel > .panel-heading > .panel-title-link.collapsed').click();" />
					<b:commandLink value="Download FASTA for all hits"
						action="#{fastaLibrarySearchBean.actionDownloadAllResultsAsFasta()}"
						iconAwesome="download" iconAlign="left" />
				</b:panelGrid>
				<br />
				<h:panelGroup styleClass="fastaResultPanelGroup">
					<ui:repeat value="#{fastaLibrarySearchBean.results}" var="result"
						varStatus="status">
						<b:panel styleClass="fastaResultPanel">
							<f:facet name="heading">
								<!-- <h:panelGroup styleClass="panel-title"> -->
								<h:outputFormat value="Result {0}/{1}"
									style="padding-right:20px;">
									<f:param value="#{status.index + 1}" />
									<f:param value="#{status.end}" />
								</h:outputFormat>
								<h:outputText value="#{result.fastaResult.subjectSequenceName}"
									style="font-size:large;" />
								<h:outputText
									value="#{result.fastaResult.subjectSequenceDescription}"
									style="padding-left:20px;" />
								<!-- </h:panelGroup> -->
							</f:facet>
							<b:panelGrid col-spans="2,1,1,1,2,1,2,1,1">
								<b:commandLink value="Download FASTA"
									action="#{fastaLibrarySearchBean.actionDownloadResultAsFasta(result, status.index + 1)}"
									iconAwesome="download" iconAlign="left" />
								<h:outputText value="Hit length" />
								<h:outputText value="Bit Score" />
								<h:outputText value="E()-Value" />
								<h:outputText value="Smith-Waterman Score" />
								<h:outputText value="Identity" />
								<h:outputText value="Similarity (Positives)" />
								<h:outputText value="Overlap" />
								<h:outputText value="Frame"
									rendered="#{fastaLibrarySearchBean.searchMode == 'DNA_DNA'}" />
								<h:outputText />
								<h:outputText
									value="#{result.fastaResult.subjectSequenceLength}" />
								<h:outputText value="#{result.fastaResult.bitScore}" />
								<h:outputText value="#{result.fastaResult.expectationValue}" />
								<h:outputText value="#{result.fastaResult.smithWatermanScore}" />
								<h:outputText
									value="#{of:formatPercent(result.fastaResult.identity)}" />
								<h:outputText
									value="#{of:formatPercent(result.fastaResult.similarity)}" />
								<h:outputText value="#{result.fastaResult.overlap}" />
								<h:outputText value="#{result.fastaResult.frame.name}"
									rendered="#{fastaLibrarySearchBean.searchMode == 'DNA_DNA'}" />
							</b:panelGrid>
							<hr />
							<b:row>
								<b:column span="10" offset="2">
									<h:outputText value="#{result.alignments}"
										style="white-space:pre; font-family:monospace;" />
								</b:column>
							</b:row>
						</b:panel>
					</ui:repeat>
				</h:panelGroup>
			</h:panelGroup>
			<hr />
			<h2>FASTA program output</h2>
			<b:panel id="fastaOutputId" title="Output" collapsed="true"
				rendered="#{not fastaLibrarySearchBean.fastaOutput.isEmpty()}">
				<h:outputText value="#{fastaLibrarySearchBean.fastaOutput}"
					style="white-space:pre; font-family:monospace;" />
			</b:panel>
		</b:form>
	</b:container>
</h:body>
</html>